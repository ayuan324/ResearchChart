# 项目架构与目录说明

本项目采用 Next.js(App Router) + 静态 HTML 页面组合的方式部署在 Vercel。UI 由 public 下的静态 HTML 承载；服务端仅提供 API 路由。模型调用统一通过 OpenRouter 实现。

## 架构概览

- 前端展示：app_demo/public 下的 HTML 静态页（home/upload/analysis/result），浏览器侧管理本地状态（localStorage.paperData）
- 服务端 API：Next.js App Router 的 API Route（/api/ingest、/api/plan）
- 根路由：/ 重定向到 /home.html（轻量入口，无 React 页面）
- 部署目标：Vercel（Root Directory 指向 app_demo）

## 页面与路由

- /home.html：网站主页。按钮跳转 /upload.html
- /upload.html：用户上传页。调用 /api/ingest 成功后跳转 /analysis.html
- /analysis.html：分析页。默认展示表格 Tab；无数据则回到 /upload.html；“Generate Charts”跳转 /result.html
- /result.html：最终图表页。展示生成图片 + 原始表（后续可接入真实渲染）
- /：由 app_demo/app/page.tsx 重定向到 /home.html

## API 路由

- /api/ingest：接收 PDF，调用 LlamaParse 获取 Markdown + 表格，落地到 JSON；浏览器端持久化到 localStorage.paperData
- /api/flow：三阶段 Agent 流程（主题与风格代理 → 图表规划代理 → 绘图代理），生成 ECharts 配置（option）

## 数据流

1) 用户在 /upload.html 上传 PDF → POST /api/ingest
2) 服务端解析 → 返回 { summary/key_findings, tables, table_conclusions, markdown }
3) 前端保存到 localStorage.paperData
4) 跳转 /analysis.html 渲染“Key Findings/表格/结论/原文 MD”
5) 点击生成图按钮 → 跳转 /result.html（后续接入方案渲染与导出）

## 目录树（精简后）

```
app_demo/
  app/
    api/
      ingest/route.ts    # PDF 解析与表格提取
      flow/route.ts      # 三阶段 Agent 流程（主题→规划→绘图）
    layout.tsx
    page.tsx             # 仅负责将 / 重定向到 /home.html
  lib/
    prompts.ts           # 所有 Agent 的 Prompt 模板
    utils.ts
  public/
    home.html            # 主页
    upload.html          # 上传页
    analysis.html        # 分析页（展示表格与结论）
    result.html          # 结果页（ECharts 图表渲染）
  next.config.mjs
  package.json
  tsconfig.json

```

## 环境变量

- OPENROUTER_API_KEY：OpenRouter API Key（所有模型统一通过 OpenRouter）
- LLAMAPARSE_API_KEY：LlamaParse Key（PDF→Markdown/表格）

在 Vercel 的项目 Settings → Environment Variables 中配置。开发本地可使用 .env.local（不要提交到仓库）。

## 开发与调试

- 开发
  - cd app_demo && npm install
  - npm run dev
  - 访问 http://localhost:3000/home.html
- 构建
  - npm run build
- 生产
  - 合并到 main 分支后，Vercel 自动构建与部署

## 规范与约定

- 代码风格：Google 代码风格
- 模型调用：统一 OpenRouter；避免直接对接厂商 SDK
- 文档位置：docs/
- 页面命名：统一 ASCII 路径（避免中文路径在构建/路由的兼容性问题）

## 三阶段 Agent 框架

本项目采用三阶段 Agent 架构生成科研图表：

### 1. 主题与风格代理（Theme & Style Agent）
- **输入**：论文摘要、用户偏好
- **输出**：全局主题配置（palette, font_family, font_size, background, grid）
- **职责**：确定整体视觉风格，保证图表一致性

### 2. 图表规划代理（Design Agent）
- **输入**：表头 schema、表格结论、用户偏好
- **输出**：逐表图表方案（pitch, chart_type, data_mapping）
- **职责**：为每个表格设计最合适的图表类型和数据映射

### 3. 绘图代理（Renderer Agent）
- **输入**：图表方案、主题样式
- **输出**：ECharts 选项（per_table_specs）
- **职责**：生成可渲染的 ECharts JSON 选项

## 后续规划（建议）

- 添加图表导出功能（PNG/SVG/PDF）
- 支持用户上传参考图片进行风格迁移
- 添加图表交互编辑功能
- 优化 Prompt 以提高图表质量
- 添加更多图表类型支持（violin, radar, sankey 等）
